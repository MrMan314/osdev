.CODE16

.GLOBAL _start

_start:
	JMP MAIN

INTHAND:/*
	MOV $0xA000, %AX
	MOV %AX, %ES
*/
	PUSH %AX
	PUSH %BX
	XOR %AX, %AX
	IN $0x60, %AL
	CMP $0x80, %AX
	JGE .SKIP
	ADD $KBMAP, %AX
	MOV %AX, %SI
	LODSB
	MOV $0x0E, %AH
	MOV $0x000F, %BX
	INT $0x10
	.SKIP:
	POP %BX
	MOV $0x20, %AL
	OUT %AL, $0x20
	POP %AX

	AND $0x80, %BL
	JNZ .DONE

.DONE:
	IRET

MAIN:
	MOV $0x02, %AH
	XOR %BH, %BH
	MOV $0x0800, %DX
	INT $0x10

	MOV $0xA000, %AX
	MOV %AX, %ES

	MOV $0x0228, %AX
	MOV $0x0011, %CX
	XOR %DH, %DH
	XOR %BX, %BX
	MOV $0x0000, %BX
	INT $0x13

	XOR %AX, %AX
	MOV %AX, %ES

	MOV $TEST, %SI
	CALL PRINT

	XOR %AX, %AX
	MOV %AX, %DS
	MOV %AX, %ES
	MOV %AX, %FS
	MOV %AX, %GS
	MOV %AX, %SS
	MOVW $0x3000, %SP

	CLI
	MOVW $INTHAND, %ES:(0x09*4)
	MOVW $0x0, %ES:(0x09*4+2)
	STI

.LOOP:
	JMP .LOOP

PRINT:
	PUSHA
PRINTSTART:
	XORB %BH, %BH
	MOVB $0x0F, %BL
	MOVB $0x0E, %AH
	LODSB
	OR %AL, %AL
	JZ PRINTDONE
	INT $0x10
	JMP PRINTSTART
PRINTDONE:
	POPA
	RET

DISP:
	PUSHA
	XOR %CX, %CX
	XOR %DX, %DX 
DISPSTART:
	CMP $0x5000, %CX
	JGE DISPDONE
	LODSB
	MOV $0x0C, %AH
	INT $0x10
	INC %CX
	JMP DISPSTART
DISPDONE:
	POPA
	RET

.SECTION .rodata
TEST: .ASCIZ "welcome to freaky os\r\n > "
KBMAP:
	.BYTE 0
	.BYTE 0x1b
	.ASCIZ "1234567890-=\b\tqwertyuiop[]\n"
	.ASCIZ "asdfghjkl;'`"
	.ASCIZ "\\zxcvbnm,./"
	.BYTE 0x2a
	.BYTE 0x0D
	.BYTE 0x20

