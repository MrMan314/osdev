.CODE16

.GLOBAL _start

_start:
	JMP MAIN

INTHAND:/*
	MOV $0xA000, %AX
	MOV %AX, %ES
*/
	PUSH %AX
	PUSH %BX
	XOR %AX, %AX
	IN $0x60, %AL
	CMP $0x80, %AX
	JGE .SKIP
	ADD $KBMAP, %AX
	MOV %AX, %SI
	LODSB
	MOV $0x0E, %AH
	MOV $0x000F, %BX
	INT $0x10
	.SKIP:
	POP %BX
	MOV $0x20, %AL
	OUT %AL, $0x20
	POP %AX

	AND $0x80, %BL
	JNZ .DONE

.DONE:
	IRET

MAIN:
	
	MOV $TEST, %SI
	CALL PRINT

	XOR %AX, %AX
	MOV %AX, %DS
	MOV %AX, %ES
	MOV %AX, %FS
	MOV %AX, %GS
	MOV %AX, %SS
	MOVW $0x1200, %SP
	
	CLI
	XOR %AX, %AX
	MOV %AX, %ES
	MOVW $INTHAND, %ES:(0x09*4)
	MOVW $0x0, %ES:(0x09*4+2)
	STI

.LOOP:
	JMP .LOOP

PRINT:
	PUSHA
PRINTSTART:
	XORB %BH, %BH
	MOVB $0x0F, %BL
	MOVB $0x0E, %AH
	LODSB
	OR %AL, %AL
	JZ PRINTDONE
	INT $0x10
	JMP PRINTSTART
PRINTDONE:
	POPA
	RET

CHAR: .WORD 0x0000
.SECTION .rodata
TEST: .ASCIZ "test\r\n"
TEST2: .ASCIZ "test2\r\n"
TEST3: .ASCIZ "test3\r\n"
KBMAP:
	.BYTE 0
	.BYTE 0x1b
	.ASCIZ "1234567890-=\b\tqwertyuiop[]\n"
	.ASCIZ "asdfghjkl;'`"
	.ASCIZ "\\zxcvbnm,./"
	.BYTE 0
	.BYTE 0x2a
	.BYTE 0
	.BYTE 0x20

