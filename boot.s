.CODE16

.GLOBAL _start

_start:
	CLI
	MOVW $0x9000, %SP
	MOVW %BP, %SP
	MOV %DL, BD
	LJMP $0x0, $MAIN

MAIN:
	XOR %AX, %AX
	MOV %AX, %DS
	MOV %AX, %ES
	MOV %AX, %FS
	MOV %AX, %GS
	MOV %AX, %SS
	MOVW $0x7C00, %SP

	MOV $HELLO, %SI
	CALL PRINT

	MOV BD, %DL
	MOV $0x41, %AH
	MOV $0x55AA, %BX
	INT $0x13
	JC .ERR

	CMP $0xAA55, %BX
	JNZ .ERR

	TEST $0x0001, %CX
	JZ .ERR
	JMP .READSTART
DAPACK:
	.BYTE 0x10
	.BYTE 0
	.WORD 64
	.WORD 0x7E00
	.WORD 0x0000

	.WORD 1
	.WORD 0
	.WORD 0
	.WORD 0
DAPACK2:
	.BYTE 0x10
	.BYTE 0
	.WORD 64
	.WORD 0x7E00
	.WORD 0x0000

	.WORD 64
	.WORD 0
	.WORD 0
	.WORD 0
.READSTART:
	MOV $DAPACK, %SI
	MOV $0x42, %AH
	MOV BD, %DL
	INT $0x13
	JC .ERR2

	MOVW $0x0013, %AX
	INT $0x10

	MOV $0x7E00, %SI
	CALL DISP
	
	MOV $DAPACK2, %SI
	MOV $0x42, %AH
	MOV BD, %DL
	INT $0x13
	JC .ERR2

	MOV $0x7FFF, %SI
	CALL DISP2

	JMP .LOOP
DISP:
	PUSHA
	XOR %CX, %CX
	XOR %DX, %DX
	JMP DISPSTART
DISP2:
	PUSHA
	MOV $102, %DX
	MOV $127, %CX
DISPSTART:
	XORB %BH, %BH
	MOVB $0x0C, %AH
	LODSB
	CMP $0x7FFF, %CX
	JGE DISPDONE
	INT $0x10
	INC %CX
	JMP DISPSTART
DISPDONE:
	POPA
	RET

PRINT:
	PUSHA
PRINTSTART:
	XORB %BH, %BH
	MOVB $0x0E, %AH
	LODSB
	OR %AL, %AL
	JZ PRINTDONE
	INT $0x10
	JMP PRINTSTART
PRINTDONE:
	POPA
	RET

.ERR2:
	MOV $ERR2, %SI
	CALL PRINT
	JMP .LOOP
.ERR:
	MOV $ERR, %SI
	CALL PRINT
.LOOP:
	JMP .LOOP


BD: .WORD 0x0000
HELLO: .ASCIZ "hello vro\r\n"
ERR: .ASCIZ "help vro\r\n"
ERR2: .ASCIZ "VRO HELP ME\r\n"
.FILL 0x1FE-(.-_start), 0x01, 0x00
.WORD 0xAA55
