.CODE32

.GLOBL ANALYZE_RSDT
.GLOBL LOCATE_RSDT
.GLOBL LOAD_SDT
.EXTERN NL
.EXTERN PRINT
.EXTERN PRINT_N
.EXTERN PRINT_HEX_8
.EXTERN PRINT_HEX_16
.EXTERN PRINT_HEX_32

LOCATE_RSDT:
	MOV $0x0F, %CH
	MOV $0xE0000, %EBX

SEARCH_LOOP:
	// "RSD "
	CMPL $0x20445352, (%EBX)
	JNE .FALSE_FLAG
	// "PTR "
	CMPL $0x20525450, 4(%EBX)
	JE RSDP_FOUND

	.FALSE_FLAG:
	ADD $16, %EBX
	CMP $0xFFFFF, %EBX

	JG FAIL
	JMP SEARCH_LOOP

RSDP_FOUND:
	LEA FOUND, %ESI
	CALL PRINT
	MOV %EBX, %EAX
	CALL PRINT_HEX_32
	CALL NL
	XOR %EAX, %EAX
	XOR %DL, %DL
	MOV $20, %ECX

	PUSH %EBX
	CALL CHECKSUM_VALID
	POP %EBX

	MOV $0x0F, %CH
	LEA OEMID, %ESI
	CALL PRINT

	ADD $9, %EBX
	MOV $6, %EDX
	MOV %EBX, %ESI
	CALL PRINT_N
	CALL NL

	ADD $7, %EBX
	LEA RSDT_ADDR, %ESI
	CALL PRINT
	MOV (%EBX), %EAX
	CALL PRINT_HEX_32
	CALL NL

	POP %EBX
	PUSH %EAX
	PUSH %EBX

	RET

LOAD_SDT:
	MOV 4(%ESP), %EBX
	XOR %EAX, %EAX
	XOR %DL, %DL
	MOV 4(%EBX), %ECX

	PUSH %ECX
	PUSH %EBX
	CALL CHECKSUM_VALID
	POP %EBX
	POP %EAX

	MOV $0x0F, %CH

	LEA SDT_LENGTH, %ESI
	CALL PRINT
	CALL PRINT_HEX_32
	CALL NL
	SUB $36, %EAX
	ADD $36, %EBX
	POP %EDX
	PUSH %EAX
	PUSH %EBX
	PUSH %EDX
	RET

ANALYZE_RSDT:
	MOV 4(%ESP), %EAX
	MOV 8(%ESP), %ECX
	MOV $4, %EDX

SHOW_LOOP:
	PUSH %ECX
	MOV $0x0F, %CH
	PUSH %EAX
	MOV (%EAX), %EAX
	LEA LIST_ENTRY, %ESI
	CALL PRINT
	CALL PRINT_HEX_32
	LEA SEP, %ESI
	CALL PRINT
	MOV %EAX, %ESI
	CALL PRINT_N
	CALL NL
	PUSHAL
	PUSH %EAX
	CALL LOAD_SDT
	ADD $12, %ESP
	POPAL
	POP %EAX
	ADD $4, %EAX
	POP %ECX
	SUB $3, %ECX
	CALL NL
	LOOP SHOW_LOOP
	RET

CHECKSUM_VALID:
	MOV 4(%ESP), %EBX
CHECKSUM_LOOP:
	MOV (%EBX), %DL
	ADD %DL, %AL
	INC %EBX
	LOOP CHECKSUM_LOOP

	OR %AL, %AL
	JNZ CHECKSUM_FAIL
	RET

CHECKSUM_FAIL:
	LEA CHECKSUM_INVALID, %ESI
	JMP FAILURE

FAIL:
	LEA NOT_FOUND, %ESI

FAILURE:
	MOV $0x0C, %CH
	CALL PRINT
	CALL PRINT_HEX_8
	CALL NL

HANG:
	JMP HANG

.SECTION .rodata
FOUND: .ASCIZ "[ ACPI ] RSDP FOUND: 0x"
OEMID: .ASCIZ "[ ACPI ] OEMID: "
RSDT_ADDR: .ASCIZ "[ ACPI ] RSDT address: 0x"
NOT_FOUND: .ASCIZ "[ ACPI ] RSDP NOT FOUND!"
CHECKSUM_INVALID: .ASCIZ "[ ACPI ] CHECKSUM INVALID!"
SDT_LENGTH: .ASCIZ "[ ACPI ] SDT length: 0x"
LIST_ENTRY: .ASCIZ "[ ACPI ] SDT @0x"
SEP: .ASCIZ ": "
