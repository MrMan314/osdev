.CODE16

.GLOBL _start
.GLOBL .TEST_FAIL
.EXTERN NL
.EXTERN PRINT
.EXTERN PRINT_HEX
.EXTERN PS2_START

_start:
	JMP MAIN

KBHAND:
	PUSH %AX
	PUSH %BX
	PUSH %SI
	XOR %AX, %AX
	INB $0x60, %AL
	CMP $0x80, %AX
	JGE .SKIP
	CMP $0x1C, %AX
	JE .NL
	ADD $KBMAP, %AX
	MOV %AX, %SI
	LODSB
	OR %AL, %AL
	JZ .SKIP
	MOV $0x0E, %AH
	MOV $0x000F, %BX
	INT $0x10
	JMP .SKIP
	.NL:
	MOV $NL, %SI
	CALL PRINT
	.SKIP:
	POP %SI
	POP %BX
	MOV $0x20, %AL
	OUT %AL, $0x20
	POP %AX

	AND $0x80, %BL
	JNZ .DONE

.DONE:
	IRET

MOUSEHAND:
	PUSH %AX
	INB $0x64, %AL
	AND $0x20, %AL
	JZ .MOUSECONT
	INB $0x60, %AL
	XOR %AH, %AH
	CALL PRINT_HEX
	.MOUSECONT:
	MOV $0x20, %AL
	OUT %AL, $0x20
	OUT %AL, $0xA0
	POP %AX
	IRET

TIMERHAND:
	PUSH %AX
	PUSH %SI
	MOV $TIMER_TEXT, %SI
	CALL PRINT
	MOV $0x20, %AL
	OUT %AL, $0x20
	POP %SI
	POP %AX
	IRET

DIVZHAND:
	POP %AX
	ADD $0x2, %AX
	PUSH %AX
	PUSH %SI
	MOV $DIVZ_TEXT, %SI
	CALL PRINT
	MOV $0x20, %AL
	OUT %AL, $0x20
	POP %SI
	XOR %AX, %AX
	XOR %DX, %DX
	IRET

MAIN:
	MOV $TEST, %SI
	CALL PRINT

	XOR %AX, %AX
	MOV %AX, %DS
	MOV %AX, %ES
	MOV %AX, %FS
	MOV %AX, %GS
	MOV %AX, %SS
	MOVW $0x3000, %SP

	CLI

	CALL PS2_START

	MOVW $DIVZHAND, %ES:(0x00*4)
	MOVW $0x0, %ES:(0x00*4+2)
//	MOVW $TIMERHAND, %ES:(0x08*4)
//	MOVW $0x0, %ES:(0x08*4+2)
	MOVW $KBHAND, %ES:(0x09*4)
	MOVW $0x0, %ES:(0x09*4+2)
	MOVW $MOUSEHAND, %ES:(0x74*4)
	MOVW $0x0, %ES:(0x74*4+2)
	STI

	XOR %AX, %AX
	DIV %AX

.LOOP:
	JMP .LOOP
.TEST_FAIL:
	MOV $TEST_FAIL, %SI
	CALL PRINT
	CALL PRINT_HEX
	MOV $NL, %SI
	CALL PRINT
	JMP .LOOP

PK_IDX: .BYTE 0xFF
PK_INVALID: .BYTE 0x00
CURSOR_X: .WORD 0x0000
CURSOR_Y: .WORD 0x0000
.SECTION .rodata
TEST_FAIL: .ASCIZ "FAILED: "
TEST: .ASCIZ "welcome to freaky os\r\n"
TIMER_TEXT: .ASCIZ "hello bro\r\n"
DIVZ_TEXT: .ASCIZ "bro divided by zero\r\n"

KBMAP:
	.BYTE 0x00
	.BYTE 0x1b
	.ASCIZ "1234567890-=\b\tqwertyuiop[]\n"
	.ASCIZ "asdfghjkl;'`"
	.ASCIZ "\\zxcvbnm,./"
	.BYTE 0x2a
	.BYTE 0x00
	.BYTE 0x20

