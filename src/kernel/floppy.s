.CODE32

.GLOBL FLOPPY_DETECT
.EXTERN PRINT

FLOPPY_DETECT:
	MOV $0x0F, %CH
	LEA START_MSG, %ESI
	CALL PRINT
	CALL NL

	MOV $0x10, %AL
	OUT %AL, $0x70
	XOR %EAX, %EAX
	IN $0x71, %AL

	PUSH %EAX
	LEA DRIVE_0, %ESI
	CALL PRINT
	MOV $0x07, %CH
	LEA DRIVE_TYPES, %EBX
	SHR $4, %EAX
	AND $0x0F, %EAX
	SHL $2, %EAX
	ADD %EAX, %EBX
	MOV (%EBX), %ESI
	CALL PRINT
	CALL NL

	POP %EAX
	MOV $0x0F, %CH
	LEA DRIVE_1, %ESI
	CALL PRINT
	MOV $0x07, %CH
	LEA DRIVE_TYPES, %EBX
	AND $0x0F, %EAX
	SHL $2, %EAX
	ADD %EAX, %EBX
	MOV (%EBX), %ESI
	CALL PRINT
	CALL NL
	RET

.SECTION .rodata
DRIVE_TYPES:
	.LONG DRIVE0
	.LONG DRIVE1
	.LONG DRIVE2
	.LONG DRIVE3
	.LONG DRIVE4
	.LONG DRIVE5
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
	.LONG DRIVE6
DRIVE0: .ASCIZ "none"
DRIVE1: .ASCIZ "360 KB 5.25\""
DRIVE2: .ASCIZ "1.2 MB 5.25\""
DRIVE3: .ASCIZ "720 KB 3.5\""
DRIVE4: .ASCIZ "1.44 MB 3.5\""
DRIVE5: .ASCIZ "2.88 MB 3.5\""
DRIVE6: .ASCIZ "unknown"

START_MSG: .ASCIZ "[ FLOPPY ] Detecting drives..."
DRIVE_0: .ASCIZ "[ FLOPPY ] Drive 0: "
DRIVE_1: .ASCIZ "[ FLOPPY ] Drive 1: "